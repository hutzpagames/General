<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peer.min.js"></script>

    <style>
        :root {
            --alias-red: #d92d20;
            --alias-white: #ffffff;
            --alias-dark: #2c2c2c;
            --alias-light-gray: #f7f7f7;
        }

        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
            font-family: 'Rubik', sans-serif;
            touch-action: manipulation;
            background-color: var(--alias-light-gray);
        }

        #layout-container { display: flex; flex-direction: column; height: 100%; }
        #app-wrapper { flex-grow: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 1rem; padding-bottom: calc(1rem + env(safe-area-inset-bottom)); }
        #setup-screen, #game-screen { max-height: none; overflow-y: visible; }
        #app-container { display: flex; flex-direction: column; justify-content: center; }
        .alias-title { font-weight: 900; color: var(--alias-red); text-shadow: 3px 3px 0px rgba(0,0,0,0.05); }
        .card { -webkit-perspective: 1000; perspective: 1000; transform-style: preserve-3d; transition: transform 0.6s cubic-bezier(0.25, 1, 0.5, 1); }
        .card.is-flipped { transform: rotateY(180deg); }
        .card__face { -webkit-backface-visibility: hidden; backface-visibility: hidden; position: absolute; width: 100%; height: 100%; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); border: 2px solid var(--alias-dark); }
        .card__face--front { background-color: var(--alias-white); color: var(--alias-dark); }
        .card__face--back { transform: rotateY(180deg); background-color: var(--alias-red); color: var(--alias-white); border-color: var(--alias-red); }
        .btn { transition: all 0.15s ease-in-out; border-radius: 0.75rem; font-weight: 700; }
        .btn:active { transform: scale(0.96); filter: brightness(0.95); }
        .btn-red { background-color: var(--alias-red); color: var(--alias-white); }
        .btn-outline { background-color: var(--alias-white); color: var(--alias-red); border: 2px solid var(--alias-red); }
        .score-box { background-color: var(--alias-white); border: 2px solid #e5e7eb; color: var(--alias-dark); transition: all 0.3s ease-in-out; border-radius: 0.5rem; position: relative; overflow: hidden; }
        .score-box.active { border: 2px solid var(--alias-red); }
        .modal-content { transition: opacity 0.25s ease-in-out, transform 0.25s ease-in-out; }
        .btn-outline.selected { background-color: var(--alias-red); color: var(--alias-white); }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }
    </style>

    <title>קצה הלשון - המשחק</title>
</head>

<body>

<div id="layout-container">
    <main id="app-wrapper">
        <div id="app-container" class="w-full max-w-md mx-auto">
            
            <div id="connection-screen" class="bg-white p-6 md:p-8 rounded-xl shadow-lg text-center">
                <h1 class="text-6xl mb-4 alias-title">קצה הלשון</h1>
                <p class="text-gray-500 mb-8">משחק מילים עם חברים</p>
                <div class="space-y-4">
                    <button id="host-game-btn" class="w-full py-4 px-6 text-2xl shadow-lg transform btn btn-red">
                        צור משחק חדש (מארח)
                    </button>
                    <div class="my-4 text-gray-400">או</div>
                    <div class="flex gap-2">
                        <input type="text" id="join-id-input" placeholder="הכנס קוד משחק" class="w-full p-3 border-2 border-gray-300 rounded-lg text-center text-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition">
                        <button id="join-game-btn" class="py-3 px-6 text-lg shadow-md transform btn btn-outline">
                            הצטרף
                        </button>
                    </div>
                </div>
                 <div id="connection-status" class="mt-4 text-sm text-gray-500 h-5"></div>
            </div>

            <div id="setup-screen" class="hidden bg-white p-6 md:p-8 rounded-xl shadow-lg text-center">
                
                <div id="lobby-info" class="mb-6 text-right p-4 bg-gray-50 rounded-lg border">
                    <p class="font-bold text-lg">קוד המשחק: <span id="session-id-display" class="font-mono text-red-600 select-all tracking-wider"></span></p>
                    <p class="font-bold mt-2">שחקנים מחוברים (<span id="player-count">1</span>):</p>
                    <ul id="player-list" class="list-disc list-inside text-gray-700">
                        <li>אתה (מארח)</li>
                    </ul>
                </div>

                <h1 class="text-4xl mb-2 alias-title">הגדרות משחק</h1>
                
                <div id="team-inputs-container" class="space-y-4 mb-4">
                    <div class="flex items-center gap-2">
                        <label for="team1-name" class="sr-only">שם קבוצה 1</label>
                        <input type="text" id="team1-name" placeholder="שם קבוצה 1" value="קבוצה א'" class="team-name-input w-full p-3 border-2 border-gray-300 rounded-lg text-center text-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition">
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="team2-name" class="sr-only">שם קבוצה 2</label>
                        <input type="text" id="team2-name" placeholder="שם קבוצה 2" value="קבוצה ב'" class="team-name-input w-full p-3 border-2 border-gray-300 rounded-lg text-center text-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition">
                    </div>
                </div>
                <button id="add-team-btn" class="w-full mb-6 py-2 px-4 text-md text-red-600 font-semibold rounded-lg border-2 border-dashed border-red-300 hover:bg-red-50 transition">
                    + הוסף קבוצה
                </button>

                <div class="mb-8">
                    <fieldset>
                        <legend class="block text-sm font-medium text-gray-700 mb-2">נקודות לניצחון</legend>
                        <div id="score-options" class="flex justify-center gap-2 max-w-xs mx-auto">
                            <button class="score-option w-full py-3 btn btn-outline" data-value="10">10</button>
                            <button class="score-option w-full py-3 btn btn-outline selected" data-value="20">20</button>
                            <button class="score-option w-full py-3 btn btn-outline" data-value="50">50</button>
                        </div>
                    </fieldset>
                </div>

                <button id="start-game-btn" class="w-full py-4 px-6 text-2xl shadow-lg transform btn btn-red mb-4">
                    התחל משחק
                </button>
                <div class="mt-4">
                    <a href="http://hutzpa.games/PrivacyPolicies/KtzeHalashon" target="_blank" rel="noopener noreferrer" class="text-gray-500 hover:text-red-600 text-sm underline">מדיניות פרטיות</a>
                </div>
            </div>

            <div id="game-screen" class="hidden w-full">
                <div id="game-content">
                    <div class="flex items-start justify-center gap-3 mb-6">
                        <div id="scores-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 flex-grow">
                        </div>
                        <div class="text-center bg-white rounded-lg p-2 shadow-md flex-shrink-0">
                            <div class="text-5xl font-black text-gray-800" id="timer">60</div>
                            <div class="text-sm text-gray-500">שניות</div>
                        </div>
                    </div>

                    <div class="relative h-64 mb-6">
                        <div class="card w-full h-full" id="word-card">
                            <div class="card__face card__face--front flex items-center justify-center p-6">
                                <div id="card-front-content" class="text-center">
                                    <h2 class="text-2xl md:text-3xl font-bold">התור של <span id="current-team-name-card"></span></h2>
                                    <p class="text-gray-500 mt-2">הקבוצה תתחיל בלחיצה על הקלף</p>
                                </div>
                            </div>
                            <div class="card__face card__face--back flex items-center justify-center p-6">
                                <h2 id="word-display" class="text-5xl font-extrabold text-center">מילה</h2>
                            </div>
                        </div>
                    </div>

                    <div id="action-buttons" class="grid grid-cols-2 gap-4 hidden">
                        <button id="skip-btn" class="py-5 px-6 text-2xl shadow-lg transform btn btn-outline">דלג</button>
                        <button id="correct-btn" class="py-5 px-6 text-2xl shadow-lg transform btn btn-red">הצלחנו!</button>
                    </div>
                </div>
                <div id="waiting-for-host" class="hidden text-center">
                     <h2 class="text-3xl text-gray-600">ממתין למארח שיתחיל את המשחק...</h2>
                </div>
            </div>

             <div id="turn-over-modal" role="dialog" aria-modal="true" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
                <div class="bg-white p-8 rounded-xl shadow-xl text-center max-w-sm w-full modal-content">
                    <h2 class="text-4xl font-black text-gray-800 mb-2">הזמן נגמר!</h2>
                    <p class="text-lg text-gray-600 mb-4">
                        כל הכבוד, <span id="finished-team-name" class="font-bold"></span>!
                    </p>
                    <p class="text-gray-500 mb-6">
                        הצלחתם <span id="turn-score" class="font-bold text-2xl" style="color: var(--alias-red);">0</span> מילים.
                    </p>
                    <button id="next-turn-btn" class="w-full py-3 px-6 text-xl shadow-lg transform btn btn-red">
                        התור הבא
                    </button>
                </div>
            </div>
            <div id="winning-screen" role="dialog" aria-modal="true" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
                <div class="bg-white p-8 rounded-xl shadow-xl text-center max-w-sm w-full transform scale-95 opacity-0 modal-content" id="winning-modal-content">
                    <div class="text-6xl mb-4">🏆</div>
                    <h2 class="text-4xl font-black text-gray-800 mb-2">ניצחון!</h2>
                    <p class="text-lg text-gray-600 mb-6">
                        קבוצת <span id="winning-team-name" class="font-bold text-2xl" style="color: var(--alias-red);"></span> ניצחה!
                    </p>
                    <button id="play-again-btn" class="w-full py-3 px-6 text-xl shadow-lg transform btn btn-red">
                        שחקו שוב
                    </button>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // =======================================================
    // PEER-TO-PEER AND NETWORKING LOGIC
    // =======================================================
    let peer;
    let hostConnection; // For players to talk to the host
    const playerConnections = new Map(); // For the host to talk to players (Map<peerId, conn>)
    let myPeerId;
    let isHost = false;

    // --- DOM Elements for Networking ---
    const connectionScreen = document.getElementById('connection-screen');
    const setupScreen = document.getElementById('setup-screen');
    const gameScreen = document.getElementById('game-screen');
    const hostGameBtn = document.getElementById('host-game-btn');
    const joinGameBtn = document.getElementById('join-game-btn');
    const joinIdInput = document.getElementById('join-id-input');
    const sessionIdDisplay = document.getElementById('session-id-display');
    const playerList = document.getElementById('player-list');
    const playerCount = document.getElementById('player-count');
    const connectionStatus = document.getElementById('connection-status');
    
    // --- Initialization ---
    function initializePeer(id = null) {
        connectionStatus.textContent = 'מתחבר לרשת...';
        peer = id ? new Peer(id) : new Peer();

        peer.on('open', (id) => {
            console.log('My peer ID is: ' + id);
            myPeerId = id;
            if (isHost) {
                sessionIdDisplay.textContent = id;
                connectionScreen.classList.add('hidden');
                setupScreen.classList.remove('hidden');
            }
            connectionStatus.textContent = '';
        });

        peer.on('error', (err) => {
            console.error('PeerJS Error:', err);
            if (err.type === 'peer-unavailable') {
                 connectionStatus.textContent = `שגיאה: קוד המשחק לא נמצא.`;
            } else {
                 connectionStatus.textContent = `שגיאה. נסה לרענן את העמוד.`;
            }
        });

        if (isHost) {
            peer.on('connection', (conn) => {
                console.log('Incoming connection from', conn.peer);
                playerConnections.set(conn.peer, conn);
                updatePlayerList();
                
                conn.on('data', (data) => {
                    handlePlayerMessage(conn.peer, data);
                });
                
                conn.on('close', () => {
                    console.log(`Connection closed with ${conn.peer}`);
                    playerConnections.delete(conn.peer);
                    updatePlayerList();
                });
            });
        }
    }
    
    // --- Event Listeners for Networking Buttons ---
    hostGameBtn.addEventListener('click', () => {
        isHost = true;
        initializePeer();
    });

    joinGameBtn.addEventListener('click', () => {
        const hostId = joinIdInput.value.trim();
        if (!hostId) {
            alert('יש להכניס קוד משחק');
            return;
        }
        isHost = false;
        initializePeer(); 

        setTimeout(() => {
            if (!peer) return;
            console.log(`Attempting to connect to host: ${hostId}`);
            connectionStatus.textContent = `מתחבר ל-${hostId}...`;
            hostConnection = peer.connect(hostId);

            hostConnection.on('open', () => {
                console.log('Successfully connected to host!');
                connectionStatus.textContent = 'מחובר!';
                connectionScreen.classList.add('hidden');
                gameScreen.classList.remove('hidden');
                document.getElementById('game-content').classList.add('hidden');
                document.getElementById('waiting-for-host').classList.remove('hidden');
            });

            hostConnection.on('data', (data) => {
                handleHostMessage(data);
            });
            hostConnection.on('error', (err) => {
                console.error("Connection error:", err);
                connectionStatus.textContent = "שגיאת חיבור למארח."
            });

        }, 500);
    });

    function updatePlayerList() {
        if(!isHost) return;
        playerList.innerHTML = '<li>אתה (מארח)</li>';
        for (const peerId of playerConnections.keys()) {
            const playerLi = document.createElement('li');
            playerLi.textContent = `שחקן (${peerId.slice(0, 5)}...)`;
            playerList.appendChild(playerLi);
        }
        playerCount.textContent = playerConnections.size + 1;
    }

    // --- Communication Functions ---
    function broadcastToPlayers(data) {
        if (!isHost) return;
        for (const conn of playerConnections.values()) {
            conn.send(data);
        }
    }
    
    function sendToHost(data) {
        if (isHost || !hostConnection) return;
        hostConnection.send(data);
    }
    
    // =======================================================
    // GAME STATE AND LOGIC
    // =======================================================
    
    const defaultWords = ["שולחן", "כסא", "מחשב", "טלפון", "אהבה", "לרוץ", "שמח", "מכונית", "כלב", "חתול", "שמש", "ירח", "ספר", "בית ספר", "ים", "חופש", "אוכל", "ארנק", "משקפיים", "עגבניה", "מלפפון", "ענן", "גשם", "מטריה", "כדורגל", "כדורסל", "מטוס", "רכבת", "אופניים", "מוזיקה", "גיטרה", "פסנתר", "יום הולדת", "מתנה", "בלון", "עוגה", "חתונה", "תינוק", "משפחה", "חברים", "עבודה", "כסף", "בנק", "קניון", "חנות", "בגד ים", "מגבת", "כובע", "נעליים", "גרביים", "חולצה", "מכנסיים", "שמלה", "טלוויזיה", "סרט", "חדשות", "אינטרנט", "מקלדת", "עכבר", "מדפסת", "וילון", "חלון", "דלת", "מפתח", "מיטה", "שמיכה", "כרית", "ארון", "מנורה", "מראה", "מברשת שיניים", "סבון", "שמפו", "מלחמה", "שלום", "צבא", "חייל", "מדינה", "דגל", "תקווה", "חלום", "כעס", "פחד", "בדיחה", "צחוק", "דמעה", "חיוך", "לב", "מוח", "יד", "רגל", "אף", "אוזן", "פה", "עין", "שיער", "ציפורן", "אצבע", "קיץ", "חורף", "אביב", "סתיו", "פרח", "עץ", "דשא", "נהר", "הר", "מדבר", "ג'ונגל", "מפה", "מצפן", "כוכב", "גלקסיה", "כדור הארץ", "חללית", "אסטרונאוט", "מדען", "רופא", "מורה", "שוטר", "כבאי", "טבח", "זמר", "שחקן", "רקדן", "צייר", "סופר", "אריה", "נמר", "פיל", "ג'ירפה", "קוף", "זברה", "היפופוטם", "תנין", "נחש", "צב", "דולפין", "כריש", "לוויתן", "פינגווין", "דוב", "זאב", "שועל", "צבי", "ינשוף", "נשר", "מהנדס", "עורך דין", "מעצב", "מתכנת", "אמן", "גנן", "ספר", "אופה", "קונדיטור", "פסטה", "פיצה", "המבורגר", "סושי", "שניצל", "אורז", "תפוח אדמה", "בטטה", "גזר", "בצל", "שום", "פלפל", "חציל", "קישוא", "ברוקולי", "כרובית", "תירס", "אפונה", "חומוס", "טחינה", "פלאפל", "שווארמה", "קפה", "תה", "מיץ", "יין", "בירה", "ירושלים", "תל אביב", "חיפה", "באר שבע", "אילת", "מצרים", "ירדן", "ארצות הברית", "סין", "יפן", "רוסיה", "צרפת", "אנגליה", "איטליה", "ספרד", "גרמניה", "בית קפה", "מסעדה", "ספריה", "מוזיאון", "תיאטרון", "קולנוע", "בריכה", "פארק", "גן חיות", "שדה תעופה", "תחנת רכבת", "גולגולת", "עמוד שדרה", "צלעות", "כתף", "מרפק", "שורש כף היד", "ברך", "קרסול", "עקב", "ריאות", "כבד", "קיבה", "אגם", "נחל", "מפל", "גבעה", "צוק", "חוף", "אי", "יער", "שדה", "כרם", "מערה", "הר געש", "כוכב", "צעיף", "כפפות", "עניבה", "חגורה", "צמיד", "שרשרת", "עגילים", "טבעת", "שעון", "תיק", "תרמיל", "מזוודה", "מטפחת", "פטיש", "מברג", "מסור", "צבת", "מקדחה", "מטר", "שפכטל", "אומץ", "סבלנות", "קנאה", "גאווה", "בלבול", "הפתעה", "אכזבה", "סקרנות", "ביטחון", "עצלנות", "נדיב", "קמצן", "לכתוב", "לקרוא", "לצייר", "לשיר", "לרקוד", "לבשל", "לאפות", "לנקות", "לסדר", "לקנות", "למכור", "לטייל", "לנהוג", "לטוס", "לשחות", "לצלול", "לטפס", "לגלוש", "להחליק", "לחשוב", "לזכור", "לשכוח", "להבין", "להסביר", "לשאול", "לענות", "להקשיב", "לדבר", "לצעוק", "ללחוש", "ספה", "כורסה", "שטיח", "תמונה", "עציץ", "אגרטל", "סיר", "מחבת", "צלחת", "קערה", "כוס", "ספל", "קומקום", "מיקרוגל", "תנור", "מקרר", "מקפיא", "מדיח כלים", "מכונת כביסה", "מייבש", "מגהץ", "קרש גיהוץ", "שואב אבק", "מטאטא", "יעה", "דלי", "סמרטוט", "טניס", "שחייה", "ריצה", "אופניים", "יוגה", "פילאטיס", "הרמת משקולות", "גלישה", "סקי", "שייט", "דייג", "צילום", "נגינה", "משחק מחשב", "טיולים", "קמפינג", "דמוקרטיה", "קפיטליזם", "סוציאליזם", "היסטוריה", "גאוגרפיה", "מתמטיקה", "פיזיקה", "כימיה", "ביולוגיה", "פילוסופיה", "פסיכולוגיה", "אומנות", "מדע", "טכנולוגיה", "חוק", "צדק", "חופש", "שוויון", "אחריות", "הצלחה", "כישלון", "עתיד", "עבר", "הווה", "אוטובוס", "מונית", "משאית", "קטנוע", "מסוק", "ספינה", "יאכטה", "ראש ממשלה", "קורקינט", "גורד שחקים", "מגדל", "ארמון", "טירה", "אוהל", "בית חולים", "מרפאה", "משטרה", "עירייה", "כנסת", "בית משפט", "פסטיבל", "קונצרט", "הצגה", "תערוכה", "הפגנה", "בחירות", "מסיבה", "אזכרה", "טקס", "אולימפיאדה", "עץ", "מתכת", "פלסטיק", "זכוכית", "בד", "צמר", "עור", "אבן", "חול", "מים", "אוויר", "אש", "אדום", "כחול", "צהוב", "ירוק", "כתום", "סגול", "ורוד", "חום", "שחור", "לבן", "אפור", "כסף", "זהב", "אבא", "אמא", "אח", "אחות", "סבא", "סבתא", "דוד", "דודה", "בן דוד", "בת דודה", "אחיין", "אחיינית", "דרכון", "תעודת זהות", "רישיון נהיגה", "כרטיס אשראי", "מזומן", "חשבון", "קבלה", "אחריות", "חוזה", "סוד","שקר", "אמת", "רעיון", "בעיה", "פתרון", "שאלה", "תשובה", "סיפור", "שיר", "סמל", "סימן", "ארוחת בוקר", "ארוחת צהריים", "ארוחת ערב", "קינוח", "מנה ראשונה", "מנה עיקרית", "אלרגיה", "ויטמין", "חלבון", "פחמימה", "שומן", "דיאטה", "מתכון", "תבלין", "רוטב", "מלח", "סוכר", "קמח", "שמן", "חמאה", "גבינה", "ביצה", "חלב", "יוגורט", "לחם", "עוגיה", "שוקולד", "גלידה", "סוכריה", "מסטיק", "אנרגיה", "כוח", "מהירות", "גובה", "רוחב", "עומק", "משקל", "טמפרטורה", "לחץ", "רעש", "שקט", "אור", "חושך", "צורה", "גודל", "כמות", "איכות", "מחיר", "הנחה", "מבצע", "חשבונית", "עודף", "טיפ", "מס", "תקציב", "הוצאה", "הכנסה", "חיסכון", "השקעה", "בורסה", "מניה", "ריבית", "הלוואה", "משכנתא", "ביטוח", "פנסיה", "פרישה", "הורים", "ילדים", "סבים", "נכדים", "בעל", "אישה", "בן זוג", "בת זוג", "חתן", "כלה", "גיס", "גיסה", "חם", "חמות", "ילד", "נער", "מבוגר", "קשיש", "ידיד", "אדם", "איש", "אישה", "ראש", "פנים", "שן", "לשון", "שפתיים", "סנטר", "צוואר", "גב", "חזה", "בטן", "זרוע", "כף רגל", "עור", "כליה", "עצם", "שריר", "דם", "סוס", "פרה", "חמור", "כבשה", "עז", "תרנגול", "ברווז", "יונה", "ציפור", "פרפר", "דבורה", "נמלה", "עכביש", "יתוש", "זבוב", "סרטן", "תמנון", "גמל", "קינואה", "קוסקוס", "בורגול", "חסה", "פטריה", "דלעת", "תפוח", "בננה", "תפוז", "ענבים", "אבטיח", "מלון", "תות", "מנגו", "אפרסק", "משמש", "שזיף", "לימון", "אבוקדו", "עדשים", "שעועית", "פול", "שמנת", "בשר", "עוף", "קציצה", "סטייק", "נקניקיה", "קרואסון", "בורקס", "סלט", "מרק", "כריך", "חביתה", "טוסט", "סודה", "שוקו", "חרדל", "קטשופ", "מיונז", "שידה", "מדף", "מזגן", "סכו\"ם", "מזלג", "סכין", "כף", "כפית", "קרש חיתוך", "פותחן", "חדר שינה", "סלון", "מטבח", "חדר אמבטיה", "שירותים", "מרפסת", "גינה", "עיתון", "משחת שיניים", "נייר טואלט", "חצאית", "ג'ינס", "סוודר", "ז'קט", "מעיל", "משקפי שמש", "תכשיטים", "שלג", "ברד", "רוח", "סופה", "ברק", "רעם", "קשת בענן", "עמק", "שיח", "דירה", "בניין", "רחוב", "עיר", "יבשת", "אוניברסיטה", "גן ילדים", "בית מרקחת", "חדר כושר", "דואר", "מפעל", "משרד", "אופנוע", "מלצר", "פוליטיקאי", "נשיא", "לקפוץ", "לשבת", "לעמוד", "לשכב", "לומר", "לדעת", "להתקלח", "להתלבש", "לרצות", "להזדקק", "להרגיש", "לבנות", "לתקן", "לצלם", "גדול", "קטן", "ארוך", "קצר", "עגול", "מרובע", "עצוב", "עייף", "רעב", "צמא", "מפחד", "מופתע", "נרגש", "משועמם", "טוב", "רע", "יפה", "מכוער", "פשוט", "מורכב", "חיים", "מוות", "זמן", "סיבה", "תוצאה", "תעודה", "מחק", "על", "עם", "בלי", "ליד", "מתחת", "כל", "הרבה", "קצת", "מאוד", "תמיד", "לפעמים", "אף פעם", "מה נשמע", "מה שלומך", "תודה רבה", "על לא דבר", "אין בעיה", "לא נורא", "שנה טובה", "חג שמח"];
    
    let words = [...defaultWords];
    let availableWords = [];

    const state = {
        teams: [],
        currentTeamIndex: 0,
        timerInterval: null,
        timeLeft: 60,
        gameActive: false,
        turnScore: 0,
        roundTime: 60,
        winningScore: 20,
        isMyTurn: false,
    };

    // --- DOM Elements for Game ---
    const turnOverModal = document.getElementById('turn-over-modal');
    const winningScreen = document.getElementById('winning-screen');
    const winningModalContent = document.getElementById('winning-modal-content');
    const teamInputsContainer = document.getElementById('team-inputs-container');
    const addTeamBtn = document.getElementById('add-team-btn');
    const scoreOptions = document.getElementById('score-options');
    const startGameBtn = document.getElementById('start-game-btn');
    const scoresContainer = document.getElementById('scores-container');
    const timerDisplay = document.getElementById('timer');
    const wordDisplay = document.getElementById('word-display');
    const wordCard = document.getElementById('word-card');
    const actionButtons = document.getElementById('action-buttons');
    const currentTeamNameCard = document.getElementById('current-team-name-card');
    const correctBtn = document.getElementById('correct-btn');
    const skipBtn = document.getElementById('skip-btn');
    const finishedTeamName = document.getElementById('finished-team-name');
    const turnScoreDisplay = document.getElementById('turn-score');
    const nextTurnBtn = document.getElementById('next-turn-btn');
    const winningTeamName = document.getElementById('winning-team-name');
    const playAgainBtn = document.getElementById('play-again-btn');
    const cardFrontContent = document.getElementById('card-front-content');

    // --- Game Setup Event Listeners ---
    startGameBtn.addEventListener('click', () => { if(isHost) startGame(); });
    addTeamBtn.addEventListener('click', addTeamInput);
    teamInputsContainer.addEventListener('click', (e) => { if (e.target && e.target.classList.contains('remove-team-btn')) { e.target.parentElement.remove(); } });
    scoreOptions.addEventListener('click', (e) => { if (e.target.classList.contains('score-option')) { scoreOptions.querySelectorAll('.score-option').forEach(btn => btn.classList.remove('selected')); e.target.classList.add('selected'); } });
    
    // --- In-Game Event Listeners ---
    wordCard.addEventListener('click', () => {
        if(state.isMyTurn && !state.gameActive) {
            sendToHost({ type: 'start_turn' });
        }
    });

    correctBtn.addEventListener('click', () => sendToHost({ type: 'action', payload: 'correct' }));
    skipBtn.addEventListener('click', () => sendToHost({ type: 'action', payload: 'skip' }));
    nextTurnBtn.addEventListener('click', () => { if(isHost) setupNextTurn(); });
    playAgainBtn.addEventListener('click', () => { if(isHost) resetGame(); });

    // --- Message Handling ---
    function handleHostMessage(data) {
        switch (data.type) {
            case 'game_start':
            case 'state_update':
                Object.assign(state, data.payload.state); // Update local state
                availableWords = data.payload.availableWords || []; // Sync word list
                renderGameUI();
                break;
            case 'your_turn':
                state.isMyTurn = true;
                renderGameUI(); // Show "your turn" message
                break;
            case 'show_word':
                wordCard.classList.add('is-flipped');
                wordDisplay.textContent = data.payload.word;
                actionButtons.classList.remove('hidden');
                startTimer();
                break;
            case 'turn_over':
                endTurn(data.payload);
                break;
            case 'game_over':
                showWinningScreen(data.payload.winningTeam);
                break;
            case 'reset':
                window.location.reload();
                break;
        }
    }
    
    function handlePlayerMessage(peerId, data) {
        if (!isHost) return;
        switch (data.type) {
            case 'start_turn':
                if (!state.gameActive) {
                    const word = getNextWord();
                    const playerConn = Array.from(playerConnections.values())[state.currentTeamIndex-1]; // Simple mapping, needs improvement for robustness
                    // Send word to the specific player whose turn it is.
                    // This mapping is simplified. Assumes player connection order matches team order.
                    // A robust solution would map player IDs to teams.
                    const allConns = [null, ...playerConnections.values()]; // null for host at index 0
                    const conn = allConns[state.currentTeamIndex];
                    if(conn){
                        conn.send({ type: 'show_word', payload: { word } });
                    } else { // It's the host's turn
                        wordCard.classList.add('is-flipped');
                        wordDisplay.textContent = word;
                        actionButtons.classList.remove('hidden');
                    }
                    startTimer();
                }
                break;
            case 'action':
                if (state.gameActive) {
                    if (data.payload === 'correct') handleCorrect();
                    else if (data.payload === 'skip') handleSkip();
                }
                break;
        }
    }
    
    // --- UI Rendering ---
    function renderGameUI() {
        // Show the main game content if it's hidden
        document.getElementById('game-content').classList.remove('hidden');
        document.getElementById('waiting-for-host').classList.add('hidden');
        
        setupScreen.classList.add('hidden');
        gameScreen.classList.remove('hidden');
        turnOverModal.classList.add('hidden');
        winningScreen.classList.add('hidden');
        
        // Render scoreboard
        scoresContainer.innerHTML = '';
        state.teams.forEach((team, index) => {
            const scoreBox = document.createElement('div');
            scoreBox.className = 'score-box p-3 rounded-lg text-center shadow-md';
            if (index === state.currentTeamIndex) {
                scoreBox.classList.add('active');
            }
            scoreBox.innerHTML = `
                <div class="font-bold text-base md:text-lg truncate">${team.name}</div>
                <div class="text-2xl font-black">${team.score}</div>`;
            scoresContainer.appendChild(scoreBox);
        });

        // Render card front
        const currentTeam = state.teams[state.currentTeamIndex];
        currentTeamNameCard.textContent = currentTeam.name;
        if(state.isMyTurn) {
            cardFrontContent.innerHTML = `<h2 class="text-3xl font-bold">התור שלך!</h2><p class="text-gray-500 mt-2">לחץ על הקלף כדי להתחיל</p>`;
            // Host on their own turn
            if(isHost && state.currentTeamIndex === 0){
                cardFrontContent.innerHTML = `<h2 class="text-3xl font-bold">התור שלך (מארח)!</h2><p class="text-gray-500 mt-2">לחץ על הקלף כדי להתחיל</p>`;
                 wordCard.onclick = () => {
                    if(!state.gameActive){
                        const word = getNextWord();
                        wordCard.classList.add('is-flipped');
                        wordDisplay.textContent = word;
                        actionButtons.classList.remove('hidden');
                        startTimer();
                        correctBtn.onclick = handleCorrect;
                        skipBtn.onclick = handleSkip;
                    }
                 }
            }
        } else {
             cardFrontContent.innerHTML = `<h2 class="text-2xl md:text-3xl font-bold">התור של <span id="current-team-name-card">${currentTeam.name}</span></h2><p class="text-gray-500 mt-2">ממתין שהם יתחילו...</p>`;
             wordCard.onclick = null;
        }

        // Reset card state for next turn
        wordCard.classList.remove('is-flipped');
        actionButtons.classList.add('hidden');
        timerDisplay.textContent = state.roundTime;
        timerDisplay.parentElement.classList.remove('animate-pulse', 'bg-red-200');
    }

    // --- Core Game Logic (mostly HOST-SIDE) ---
    function addTeamInput() {
        const teamCount = teamInputsContainer.children.length;
        const newTeamInput = document.createElement('div');
        newTeamInput.className = 'flex items-center gap-2';
        newTeamInput.innerHTML = `<input type="text" placeholder="שם קבוצה ${teamCount + 1}" class="team-name-input w-full p-3 border-2 border-gray-300 rounded-lg text-center text-lg"><button class="remove-team-btn text-gray-400 hover:text-red-500 text-2xl font-bold">&times;</button>`;
        teamInputsContainer.appendChild(newTeamInput);
    }
    
    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    function getNextWord() {
        if (availableWords.length === 0) {
            availableWords = [...words];
            shuffle(availableWords);
        }
        return availableWords.pop();
    }

    function startGame() {
        state.teams = [];
        document.querySelectorAll('.team-name-input').forEach((input, index) => {
            state.teams.push({ name: input.value || `קבוצה ${index + 1}`, score: 0 });
        });
        
        // A simple check to ensure there are players for teams.
        // The host is always team 0. Each connected player is a subsequent team.
        if (playerConnections.size + 1 < state.teams.length) {
            alert(`לא מספיק שחקנים מחוברים עבור ${state.teams.length} קבוצות. מחוברים: ${playerConnections.size + 1}.`);
            return;
        }

        state.winningScore = parseInt(scoreOptions.querySelector('.selected').dataset.value);
        state.currentTeamIndex = 0;
        state.turnScore = 0;
        state.gameActive = false;
        
        availableWords = [...words];
        shuffle(availableWords);

        const payload = { state, availableWords };
        broadcastToPlayers({ type: 'game_start', payload });

        // Tell the first player it's their turn
        const firstPlayerConn = Array.from(playerConnections.values())[0];
        if (state.teams.length > 1 && firstPlayerConn) {
             // Let's assume team 0 is host, team 1 is first player, etc.
             // This is a simplification.
            state.isMyTurn = false; // Host's turn is not now
            firstPlayerConn.send({ type: 'your_turn' });
        } else {
            state.isMyTurn = true; // It's the host's turn
        }
        
        renderGameUI();
    }

    function startTimer() {
        state.gameActive = true;
        state.timeLeft = state.roundTime;
        
        const update = () => {
            timerDisplay.textContent = state.timeLeft;
            if (state.timeLeft <= 10) {
                timerDisplay.parentElement.classList.add('animate-pulse', 'bg-red-200');
            }
        };
        update();
        
        state.timerInterval = setInterval(() => {
            state.timeLeft--;
            update();
            if (state.timeLeft <= 0) {
                if (isHost) {
                    const payload = { turnScore: state.turnScore, teamName: state.teams[state.currentTeamIndex].name };
                    broadcastToPlayers({ type: 'turn_over', payload });
                    endTurn(payload); // Also for host
                }
            }
        }, 1000);
    }
    
    function handleCorrect() {
        if (!isHost || !state.gameActive) return;
        state.teams[state.currentTeamIndex].score++;
        state.turnScore++;
        
        // Get new word and send it
        const nextWord = getNextWord();
        const allConns = [null, ...playerConnections.values()];
        const conn = allConns[state.currentTeamIndex];
        if(conn){
             conn.send({ type: 'show_word', payload: { word: nextWord } });
        } else { // Host's turn
            wordDisplay.textContent = nextWord;
        }

        broadcastToPlayers({ type: 'state_update', payload: { state, availableWords } });
        renderGameUI();
    }

    function handleSkip() {
        if (!isHost || !state.gameActive) return;
        if (state.teams[state.currentTeamIndex].score > 0) {
            state.teams[state.currentTeamIndex].score--;
        }
        
        const nextWord = getNextWord();
        const allConns = [null, ...playerConnections.values()];
        const conn = allConns[state.currentTeamIndex];
         if(conn){
             conn.send({ type: 'show_word', payload: { word: nextWord } });
        } else { // Host's turn
            wordDisplay.textContent = nextWord;
        }

        broadcastToPlayers({ type: 'state_update', payload: { state, availableWords } });
        renderGameUI();
    }

    function endTurn(payload) {
        clearInterval(state.timerInterval);
        state.gameActive = false;
        state.isMyTurn = false;
        
        finishedTeamName.textContent = payload.teamName;
        turnScoreDisplay.textContent = payload.turnScore;
        turnOverModal.classList.remove('hidden');
    }

    function setupNextTurn() {
        if (!isHost) return;
        state.turnScore = 0;

        // Check for winner
        const winner = state.teams.find(team => team.score >= state.winningScore);
        if (winner) {
            broadcastToPlayers({ type: 'game_over', payload: { winningTeam: winner } });
            showWinningScreen(winner);
            return;
        }
        
        state.currentTeamIndex = (state.currentTeamIndex + 1) % state.teams.length;
        
        // Tell next player it's their turn
        const allConns = [null, ...playerConnections.values()];
        const nextConn = allConns[state.currentTeamIndex];
        if(nextConn) {
            nextConn.send({ type: 'your_turn' });
        } else { // It's the host's turn
            state.isMyTurn = true;
        }

        broadcastToPlayers({ type: 'state_update', payload: { state, availableWords } });
        renderGameUI();
    }
    
    function showWinningScreen(winningTeam) {
        state.gameActive = false;
        turnOverModal.classList.add('hidden');
        winningTeamName.textContent = winningTeam.name;
        winningScreen.classList.remove('hidden');
        setTimeout(() => {
            winningModalContent.classList.remove('scale-95', 'opacity-0');
        }, 50);
    }
    
    function resetGame() {
        if(!isHost) return;
        broadcastToPlayers({ type: 'reset' });
        window.location.reload();
    }
});
</script>

</body>
</html>
