<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    
    <style>
        :root {
            --alias-red: #d92d20;
            --alias-white: #ffffff;
            --alias-dark: #2c2c2c;
            --alias-light-gray: #f7f7f7;
        }
        html, body {
            height: 100%; margin: 0; overflow: hidden; font-family: 'Rubik', sans-serif;
            touch-action: manipulation; background-color: var(--alias-light-gray);
        }
        #layout-container { display: flex; flex-direction: column; height: 100%; }
        #app-wrapper { flex-grow: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 1rem; padding-bottom: calc(1rem + env(safe-area-inset-bottom)); }
        #setup-screen, #game-screen { max-height: none; overflow-y: visible; }
        #app-container { display: flex; flex-direction: column; justify-content: center; }
        .alias-title { font-weight: 900; color: var(--alias-red); text-shadow: 3px 3px 0px rgba(0,0,0,0.05); }
        .card { -webkit-perspective: 1000; perspective: 1000; transform-style: preserve-3d; transition: transform 0.6s cubic-bezier(0.25, 1, 0.5, 1); }
        .card.is-flipped { transform: rotateY(180deg); }
        .card__face { -webkit-backface-visibility: hidden; backface-visibility: hidden; position: absolute; width: 100%; height: 100%; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); border: 2px solid var(--alias-dark); }
        .card__face--front { background-color: var(--alias-white); color: var(--alias-dark); }
        .card__face--back { transform: rotateY(180deg); background-color: var(--alias-red); color: var(--alias-white); border-color: var(--alias-red); }
        .btn { transition: all 0.15s ease-in-out; border-radius: 0.75rem; font-weight: 700; }
        .btn:active { transform: scale(0.96); filter: brightness(0.95); }
        .btn-red { background-color: var(--alias-red); color: var(--alias-white); }
        .btn-outline { background-color: var(--alias-white); color: var(--alias-red); border: 2px solid var(--alias-red); }
        .score-box { background-color: var(--alias-white); border: 2px solid #e5e7eb; color: var(--alias-dark); transition: all 0.3s ease-in-out; border-radius: 0.5rem; position: relative; overflow: hidden; }
        .score-box.active { border: 2px solid var(--alias-red); }
        .modal-content { transition: opacity 0.25s ease-in-out, transform 0.25s ease-in-out; }
        .btn-outline.selected { background-color: var(--alias-red); color: var(--alias-white); }
        .score-change { position: absolute; top: 50%; left: 50%; font-size: 1.5rem; font-weight: 900; opacity: 0; pointer-events: none; direction: ltr; }
        .score-change.plus-one { color: #16a34a; animation: float-up-left 0.8s ease-out forwards; }
        .score-change.minus-one { color: var(--alias-red); animation: float-up-right 0.8s ease-out forwards; }
        @keyframes float-up-left { 0% { opacity: 1; transform: translate(-120%, -50%); } 100% { opacity: 0; transform: translate(-120%, -150%); } }
        @keyframes float-up-right { 0% { opacity: 1; transform: translate(20%, -50%); } 100% { opacity: 0; transform: translate(20%, -150%); } }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }
    </style>

    <title>拽爪 砖 - 砖拽</title>
</head>

<body>

<div id="layout-container">
    <main id="app-wrapper">
        <div id="app-container" class="w-full max-w-md mx-auto">

            <div id="main-menu" class="bg-white p-6 md:p-8 rounded-xl shadow-lg text-center">
                <h1 class="text-6xl mb-4 alias-title">拽爪 砖</h1>
                <p class="text-gray-500 mb-8">砖  注 专!</p>
                <div class="space-y-4">
                    <button id="host-game-btn" class="w-full py-4 px-6 text-2xl shadow-lg transform btn btn-red">
                        爪专 砖拽 砖 (专)
                    </button>
                    <button id="join-game-btn" class="w-full py-4 px-6 text-2xl shadow-lg transform btn btn-outline">
                        爪专祝 砖拽
                    </button>
                </div>
            </div>

            <div id="connection-screen" class="hidden bg-white p-6 md:p-8 rounded-xl shadow-lg text-center">
                <h2 id="connection-title" class="text-3xl font-bold text-gray-800 mb-4">转专...</h2>
                <p id="connection-instructions" class="text-gray-600 mb-6">住专拽 转 拽 砖 专</p>
                <div id="qr-code-container" class="w-64 h-64 mx-auto my-4 bg-gray-100 rounded-lg flex items-center justify-center p-2"></div>
                <div id="qr-scanner-container" class="w-full max-w-sm mx-auto rounded-lg overflow-hidden">
                    <video id="qr-video" class="w-full h-auto"></video>
                </div>
                <button id="back-to-menu-btn" class="mt-6 w-full py-3 px-6 text-lg transform btn btn-outline">
                    专 转驻专
                </button>
            </div>

            <div id="setup-screen" class="hidden bg-white p-6 md:p-8 rounded-xl shadow-lg text-center">
                <h1 class="text-6xl mb-4 alias-title">拽爪 砖</h1>
                <p class="text-gray-500 mb-8">砖  注 专!</p>

                <div id="team-inputs-container" class="space-y-4 mb-4">
                    <div class="flex items-center gap-2">
                        <label for="team1-name" class="sr-only">砖 拽爪 1</label>
                        <input type="text" id="team1-name" placeholder="砖 拽爪 1" value="拽爪 '" class="team-name-input w-full p-3 border-2 border-gray-300 rounded-lg text-center text-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition">
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="team2-name" class="sr-only">砖 拽爪 2</label>
                        <input type="text" id="team2-name" placeholder="砖 拽爪 2" value="拽爪 '" class="team-name-input w-full p-3 border-2 border-gray-300 rounded-lg text-center text-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition">
                    </div>
                </div>
                <button id="add-team-btn" class="w-full mb-6 py-2 px-4 text-md text-red-600 font-semibold rounded-lg border-2 border-dashed border-red-300 hover:bg-red-50 transition">
                    + 住祝 拽爪
                </button>

                <div class="mb-8">
                    <fieldset>
                        <legend class="block text-sm font-medium text-gray-700 mb-2">拽转 爪</legend>
                        <div id="score-options" class="flex justify-center gap-2 max-w-xs mx-auto">
                            <button class="score-option w-full py-3 btn btn-outline" data-value="10">10</button>
                            <button class="score-option w-full py-3 btn btn-outline selected" data-value="20">20</button>
                            <button class="score-option w-full py-3 btn btn-outline" data-value="50">50</button>
                        </div>
                    </fieldset>
                </div>

                <button id="start-game-btn" class="w-full py-4 px-6 text-2xl shadow-lg transform btn btn-red mb-4">
                    转 砖拽
                </button>
                <div class="grid grid-cols-2 gap-4">
                    <button id="add-words-btn" class="w-full py-3 px-6 text-lg shadow-md transform btn btn-outline">
                        住祝 
                    </button>
                    <button id="how-to-play-btn" class="w-full py-3 px-6 text-lg shadow-md transform btn btn-outline">
                         砖拽?
                    </button>
                </div>

                <div id="lobby-container" class="mt-8 pt-6 border-t border-gray-200">
                    <h3 class="text-xl font-bold text-gray-700 mb-4">砖拽 专</h3>
                    <p id="lobby-instructions" class="text-gray-500 mb-4">拽砖 砖拽 住专拽 转 拽   转 转 专.</p>
                    <div id="lobby-qr-container" class="w-48 h-48 mx-auto my-4 flex items-center justify-center p-2 bg-white border"></div>
                    <ul id="player-list" class="space-y-2 text-center list-none p-0"></ul>
                     <button id="scan-peer-answer-btn" class="mt-4 w-full py-3 btn btn-outline">住专拽 拽 砖 砖拽  砖 专</button>
                </div>
            </div>

            <div id="game-screen" class="hidden w-full">
                <div id="last-round-banner" class="hidden text-center bg-red-600 text-white font-bold p-2 mb-4 rounded-lg shadow-md animate-pulse"></div>
                <div id="tie-breaker-banner" class="hidden text-center bg-blue-600 text-white font-bold p-2 mb-4 rounded-lg shadow-md"></div>
                <div class="mb-4 text-center">
                    <button id="edit-scores-btn" class="py-2 px-5 text-sm btn btn-outline hidden">注专转 拽</button>
                </div>
                <div class="flex items-start justify-center gap-3 mb-6">
                    <div id="scores-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 flex-grow"></div>
                    <div class="text-center bg-white rounded-lg p-2 shadow-md flex-shrink-0">
                        <div class="text-5xl font-black text-gray-800" id="timer">60</div>
                        <div class="text-sm text-gray-500">砖转</div>
                    </div>
                </div>
                <div class="relative h-64 mb-6">
                    <div class="card w-full h-full" id="word-card">
                        <div class="card__face card__face--front flex items-center justify-center p-6">
                            <div class="text-center">
                                <h2 class="text-2xl md:text-3xl font-bold">转专 砖 <span id="current-team-name-card"></span></h2>
                                <p class="text-gray-500 mt-2">驻 转 拽祝  转</p>
                            </div>
                        </div>
                        <div class="card__face card__face--back flex items-center justify-center p-6">
                            <h2 id="word-display" class="text-5xl font-extrabold text-center"></h2>
                        </div>
                    </div>
                </div>
                <div id="action-buttons" class="grid grid-cols-2 gap-4 hidden">
                    <button id="skip-btn" class="py-5 px-6 text-2xl shadow-lg transform btn btn-outline"></button>
                    <button id="correct-btn" class="py-5 px-6 text-2xl shadow-lg transform btn btn-red">爪!</button>
                </div>
            </div>

            <div id="how-to-play-modal" role="dialog" aria-modal="true" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
                <div class="bg-white p-6 rounded-xl shadow-xl max-w-sm w-full text-right modal-content">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800"> 砖拽?</h2>
                        <button id="close-how-to-play-btn" class="text-gray-500 hover:text-red-500 text-3xl">&times;</button>
                    </div>
                    <div class="space-y-4 text-gray-700 text-sm md:text-base max-h-[70vh] overflow-y-auto pr-2">
                        <div>
                            <h3 class="font-bold text-red-600 text-base md:text-lg">专</h3>
                            <p>专 拽爪 砖 砖  砖转专 .</p>
                        </div>
                        <div>
                            <h3 class="font-bold text-red-600 text-base md:text-lg"> 砖拽?</h3>
                            <ul class="list-disc list-inside space-y-2 pr-2">
                                <li>转拽 拽爪转 (驻转 砖 砖  拽爪).</li>
                                <li> 住 砖拽 专 拽爪  住专.</li>
                                <li>住专 爪专 住专 拽爪 砖  砖转专  转 拽.   砖 转   抓 "爪!" 拽爪 拽转 拽.</li>
                                <li><strong>住专  转  注爪!</strong>    转 砖专砖,  拽 砖 . 住专  专 转  砖驻 专转. (砖    "" 驻砖专  "住 转 驻 砖转 专注"  住专  " 转"  "FOOD").</li>
                                <li>  注, 驻砖专 抓 ""  拽.</li>
                                <li>注专转 注 拽? 爪 ""   拽.</li>
                                <li> 爪转 注转 注 驻转专  , 驻砖专 注专 转 拽转 住祝 住.</li>
                                <li>拽爪 专砖 砖注 专转 拽转 爪转!</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div id="custom-words-modal" role="dialog" aria-modal="true" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
                <div class="bg-white p-6 rounded-xl shadow-xl max-w-sm w-full text-right modal-content">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">住驻转 </h2>
                        <button id="close-custom-words-btn" class="text-gray-500 hover:text-red-500 text-3xl">&times;</button>
                    </div>
                    <div class="space-y-4 text-gray-700">
                        <label for="custom-words-textarea" class="text-sm">住  转转 砖转,  转  砖专.</label>
                        <textarea id="custom-words-textarea" class="w-full h-40 p-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition" placeholder=":&#10;驻&#10;砖&#10;"></textarea>
                        <button id="save-custom-words-btn" class="w-full py-3 px-6 text-xl shadow-lg transform btn btn-red">
                            砖专 住祝
                        </button>
                    </div>
                </div>
            </div>
            <div id="edit-scores-modal" role="dialog" aria-modal="true" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
                <div class="bg-white p-6 rounded-xl shadow-xl max-w-sm w-full text-right modal-content">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">注专转 拽</h2>
                        <button id="close-edit-scores-btn" class="text-gray-500 hover:text-red-500 text-3xl">&times;</button>
                    </div>
                    <div id="edit-scores-list" class="space-y-4">
                    </div>
                    <button id="save-scores-btn" class="w-full mt-6 py-3 px-6 text-xl shadow-lg transform btn btn-red">
                        砖专 砖
                    </button>
                </div>
            </div>
            <div id="turn-over-modal" role="dialog" aria-modal="true" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
                <div class="bg-white p-8 rounded-xl shadow-xl text-center max-w-sm w-full modal-content">
                    <h2 class="text-4xl font-black text-gray-800 mb-2"> 专!</h2>
                    <p class="text-lg text-gray-600 mb-4">
                         , <span id="finished-team-name" class="font-bold"></span>!
                    </p>
                    <p class="text-gray-500 mb-6">
                        爪转 <span id="turn-score" class="font-bold text-2xl" style="color: var(--alias-red);">0</span> .
                    </p>
                    <button id="next-turn-btn" class="w-full py-3 px-6 text-xl shadow-lg transform btn btn-red">
                        转专 
                    </button>
                </div>
            </div>
            <div id="countdown-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
                <div id="countdown-display" class="text-9xl font-black text-white" style="text-shadow: 0 0 20px rgba(0,0,0,0.5);">3</div>
            </div>
            <div id="winning-screen" role="dialog" aria-modal="true" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
                <div class="bg-white p-8 rounded-xl shadow-xl text-center max-w-sm w-full transform scale-95 opacity-0 modal-content" id="winning-modal-content">
                    <div class="text-6xl mb-4"></div>
                    <h2 class="text-4xl font-black text-gray-800 mb-2">爪!</h2>
                    <p class="text-lg text-gray-600 mb-6">
                        拽爪转 <span id="winning-team-name" class="font-bold text-2xl" style="color: var(--alias-red);"></span> 爪!
                    </p>
                    <button id="play-again-btn" class="w-full py-3 px-6 text-xl shadow-lg transform btn btn-red">
                        砖拽 砖
                    </button>
                </div>
            </div>

        </div>
    </main>
</div> 

<script>
// --- PART 1: NEW MULTIPLAYER LOGIC ---
const multiplayer = {
    isHost: false,
    peer: null,
    connectedPeers: new Map(),
    localPlayerName: `砖拽 ${Math.floor(100 + Math.random() * 900)}`,
    stream: null,
    scanner: null
};

// Multiplayer UI Elements
const mainMenu = document.getElementById('main-menu');
const connectionScreen = document.getElementById('connection-screen');
const hostGameBtn = document.getElementById('host-game-btn');
const joinGameBtn = document.getElementById('join-game-btn');
const backToMenuBtn = document.getElementById('back-to-menu-btn');
const qrCodeContainer = document.getElementById('qr-code-container');
const qrVideo = document.getElementById('qr-video');
const qrScannerContainer = document.getElementById('qr-scanner-container');
const connectionTitle = document.getElementById('connection-title');
const connectionInstructions = document.getElementById('connection-instructions');
const lobbyQrContainer = document.getElementById('lobby-qr-container');
const playerList = document.getElementById('player-list');
const scanPeerAnswerBtn = document.getElementById('scan-peer-answer-btn');

function showScreen(screen) {
    ['main-menu', 'connection-screen', 'setup-screen', 'game-screen'].forEach(id => {
        document.getElementById(id).classList.add('hidden');
    });
    document.getElementById(screen).classList.remove('hidden');
}

function generateQR(data) {
    const qr = qrcode(0, 'L');
    qr.addData(data);
    qr.make();
    return qr.createDataURL(8);
}

function startScanner(onScan) {
    qrScannerContainer.style.display = 'block';
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(function(stream) {
            multiplayer.stream = stream;
            qrVideo.srcObject = stream;
            qrVideo.setAttribute("playsinline", true);
            qrVideo.play();
            multiplayer.scanner = requestAnimationFrame(tick);
        }).catch(err => {
            console.error("Error accessing camera: ", err);
            connectionInstructions.textContent = "砖 砖 爪.  砖专 专砖转.";
        });

    function tick() {
        if (qrVideo.readyState === qrVideo.HAVE_ENOUGH_DATA) {
            const canvasElement = document.createElement('canvas');
            const canvas = canvasElement.getContext('2d');
            canvasElement.height = qrVideo.videoHeight;
            canvasElement.width = qrVideo.videoWidth;
            canvas.drawImage(qrVideo, 0, 0, canvasElement.width, canvasElement.height);
            const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: "dontInvert",
            });
            if (code) {
                stopScanner();
                onScan(code.data);
            }
        }
        if (multiplayer.stream?.active) {
            multiplayer.scanner = requestAnimationFrame(tick);
        }
    }
}

function stopScanner() {
    cancelAnimationFrame(multiplayer.scanner);
    qrScannerContainer.style.display = 'none';
    if (multiplayer.stream) {
        multiplayer.stream.getTracks().forEach(track => track.stop());
        multiplayer.stream = null;
    }
}

// ---- HOST LOGIC ----
hostGameBtn.addEventListener('click', () => {
    multiplayer.isHost = true;
    showScreen('setup-screen');
    const hostId = `host-${Date.now()}`;
    multiplayer.peer = new SimplePeer({ initiator: true, trickle: false });

    multiplayer.peer.on('signal', offer => {
        const offerPayload = JSON.stringify({ type: 'offer', sdp: offer, hostId: hostId, name: '专' });
        lobbyQrContainer.innerHTML = `<img src="${generateQR(offerPayload)}" alt="Host QR Code">`;
    });
    
    scanPeerAnswerBtn.addEventListener('click', () => {
         connectionTitle.textContent = "住专拽 转砖 砖拽";
         connectionInstructions.textContent = "拽 转 拽 -QR 砖 砖拽  爪.";
         showScreen('connection-screen');
         qrCodeContainer.style.display = 'none';
         startScanner(answerPayloadString => {
            try {
                const { type, sdp, peerId, name } = JSON.parse(answerPayloadString);
                if (type === 'answer') {
                    const newPeerConnection = new SimplePeer({ initiator: false, trickle: false });
                    
                    newPeerConnection.on('signal', answer => {
                        // This should not happen for a non-initiator, but good to handle
                    });

                    newPeerConnection.signal(sdp); // Give the peer's answer to our new connection

                    newPeerConnection.on('connect', () => {
                         console.log(`Connected to ${name} (${peerId})`);
                         multiplayer.connectedPeers.set(peerId, { peer: newPeerConnection, name });
                         updatePlayerList();
                         newPeerConnection.send(JSON.stringify({type: 'CONNECTION_SUCCESS', name: multiplayer.localPlayerName }));
                         alert(`转专转 爪 -${name}!`);
                         showScreen('setup-screen');
                    });

                    newPeerConnection.on('data', (data) => handleIncomingData(peerId, data));
                    newPeerConnection.on('close', () => {
                        multiplayer.connectedPeers.delete(peerId);
                        updatePlayerList();
                    });
                }
            } catch(e) {
                console.error("Invalid QR code scanned:", e);
                alert("拽  转拽 住专拽. 住 砖.");
                showScreen('setup-screen');
            }
         });
    });
    updatePlayerList();
});

function updatePlayerList() {
    playerList.innerHTML = `<li><span class="font-bold">${multiplayer.localPlayerName} (专)</span></li>`;
    multiplayer.connectedPeers.forEach((p, id) => {
        playerList.innerHTML += `<li>${p.name}</li>`;
    });
}

function broadcast(data, excludeId = null) {
    const message = JSON.stringify(data);
    multiplayer.connectedPeers.forEach((p, id) => {
        if (id !== excludeId) {
            p.peer.send(message);
        }
    });
}

// ---- PEER/CLIENT LOGIC ----
joinGameBtn.addEventListener('click', () => {
    multiplayer.isHost = false;
    showScreen('connection-screen');
    connectionTitle.textContent = "爪专祝 砖拽";
    connectionInstructions.textContent = "住专拽 转 拽 -QR 砖 专  转专.";
    qrCodeContainer.style.display = 'none';
    startScanner(offerPayloadString => {
        try {
            const { type, sdp, hostId } = JSON.parse(offerPayloadString);
            if (type === 'offer') {
                const peerId = `peer-${Date.now()}`;
                multiplayer.peer = new SimplePeer({ initiator: false, trickle: false });

                multiplayer.peer.on('signal', answer => {
                    const answerPayload = JSON.stringify({ type: 'answer', sdp: answer, peerId, name: multiplayer.localPlayerName });
                    qrCodeContainer.innerHTML = `<img src="${generateQR(answerPayload)}" alt="Your Answer QR Code">`;
                    qrCodeContainer.style.display = 'block';
                    connectionTitle.textContent = "转专转 注 砖!";
                    connectionInstructions.textContent = "专 转 拽  专  住 转 专.";
                });

                multiplayer.peer.signal(sdp); 
                multiplayer.peer.on('connect', () => {
                    console.log('Connected to host!');
                    alert('转专转 爪 专! 转 转转 砖拽...');
                    showScreen('game-screen'); 
                    document.getElementById('word-card').classList.remove('is-flipped');
                    document.getElementById('action-buttons').classList.add('hidden');
                    const frontCard = document.querySelector('.card__face--front');
                    frontCard.innerHTML = `<h2 class="text-2xl md:text-3xl font-bold">专!</h2><p class="text-gray-500 mt-2">转 专 砖转 转 砖拽...</p>`;
                });
                multiplayer.peer.on('data', (data) => handleIncomingData(hostId, data));
            }
        } catch(e) {
            console.error("Invalid QR code scanned:", e);
            alert("拽  转拽 住专拽. 住 砖.");
            showScreen('main-menu');
        }
    });
});

// ---- SHARED LOGIC ----
backToMenuBtn.addEventListener('click', () => {
    stopScanner();
    showScreen('main-menu');
    // Basic reload to reset state
    window.location.reload();
});


// --- PART 2: MODIFIED ORIGINAL GAME SCRIPT ---
const defaultWords = ["砖", "住", "砖", "驻", "", "专抓", "砖", "转", "", "转", "砖砖", "专", "住驻专", "转 住驻专", "", "驻砖", "", "专拽", "砖拽驻", "注", "驻驻", "注", "砖", "专", "专", "专住", "住", "专转", "驻", "拽", "专", "驻住转专", " 转", "转", "", "注", "转", "转拽", "砖驻", "专", "注", "住祝", "拽", "拽", "转", " ", "转", "注", "注", "专", "爪", "住", "砖", "", "住专", "砖转", "专", "拽转", "注专", "驻住转", "", "", "转", "驻转", "", "砖", "专转", "专", "专", "专", "专砖转 砖", "住", "砖驻", "", "砖", "爪", "", "", "", "转拽", "", "注住", "驻", "", "爪拽", "注", "", "", "", "", "专", "祝", "", "驻", "注", "砖注专", "爪驻专", "爪注", "拽抓", "专祝", "", "住转", "驻专", "注抓", "砖", "专", "专", "专", "'", "驻", "爪驻", "", "拽住", "专 专抓", "转", "住专", "注", "专驻", "专", "砖专", "", "", "专", "砖拽", "专拽", "爪专", "住驻专", "专", "专", "驻", "'专驻", "拽祝", "专", "驻驻", "转", "砖", "爪", "驻", "专砖", "转", "驻", "", "", "砖注", "爪", "砖祝", "砖专", "住", "注专 ", "注爪", "转转", "", "", "住驻专", "驻", "拽专", "驻住", "驻爪", "专专", "住砖", "砖爪", "专", "转驻 ", "", "专", "爪", "砖", "驻驻", "爪", "拽砖", "专拽", "专转", "转专住", "驻", "住", "", "驻驻", "砖专", "拽驻", "转", "抓", "", "专", "专砖", "转 ", "驻", "专 砖注", "转", "爪专", "专", "专爪转 专转", "住", "驻", "专住", "爪专驻转", "", "", "住驻专", "专", "转 拽驻", "住注", "住驻专", "", "转专", "拽注", "专", "驻专拽", " 转", "砖 转注驻", "转转 专转", "转", "注 砖专", "爪注转", "转祝", "专驻拽", "砖专砖 祝 ", "专", "拽专住", "注拽", "专转", "", "拽", "", "", "驻", "注", "爪拽", "祝", "", "注专", "砖", "专", "注专", "专 注砖", "", "爪注祝", "驻驻转", "注", "专", "爪", "砖专砖专转", "注", "注转", "砖注", "转拽", "转专", "", "驻转", "驻砖", "专", "住专", "爪转", "拽", "专", "砖驻", "抓", "住转", "拽", "", "", "驻转注", "", "住拽专转", "", "注爪转", "", "拽爪", "转", "拽专", "爪专", "砖专", "专拽", "砖", "驻转", "拽转", "住专", "拽转", "专", "", "", "住", "砖转", "爪", "驻住", "砖", "拽", "砖", "专", "砖", "", "住专", "砖", "注转", "拽砖", "专", "爪注拽", "砖", "住驻", "专住", "砖", "转", "注爪抓", "专", "住专", "转", "爪转", "拽注专", "住", "住驻", "拽拽", "拽专", "转专", "拽专专", "拽驻", " ", "转 住", "砖", "抓", "拽专砖 抓", "砖 拽", "", "注", "", "住专", "住", "砖", "专爪", "驻", "", "驻住", "专转 砖拽转", "砖", "住拽", "砖", "", "爪", "", "砖拽 砖", "", "拽驻", "拽专", "拽驻", "住爪", "住专", "专驻", "转拽", "驻拽", "", "", "驻住驻", "驻住", "转", "注", "", "拽", "爪拽", "驻砖", "砖", "专转", "爪", "砖", "注转", "注专", "", "住", "转", "砖转", "拽注", "住拽", "住驻", "", "专砖 砖", "拽专拽", "专 砖拽", "", "专", "专", "", "转 ", "专驻", "砖专", "注专", "住转", "转 砖驻", "驻住", "拽爪专", "爪", "转注专", "驻", "专转", "住", "专", "拽住", "驻", "注抓", "转转", "驻住拽", "转", "", "爪专", "注专", "", "", "", "专", "砖", "", "", "爪", "专拽", "转", "住", "专", "", "砖专", "", "驻专", "住祝", "", "", "", "", "转", "住", "住转", "", "", " ", "转 ", "", "转", "专", "转注转 转", "专砖 ", "专住 砖专", "", "砖", "拽", "专转", "", "住","砖拽专", "转", "专注", "注", "驻转专", "砖", "转砖", "住驻专", "砖专", "住", "住", "专转 拽专", "专转 爪专", "专转 注专", "拽", " 专砖", " 注拽专转", "专", "", "", "驻", "砖", "", "转", "转", "专", "", "住专", "拽", "砖", "", "", "爪", "", "专", "", "注", "砖拽", "", "住专", "住拽", "专", "", "专转", "", "专", "注拽", "砖拽", "驻专专", "抓", "专注砖", "砖拽", "专", "砖", "爪专", "", "转", "转", "专", "", "爪注", "砖转", "注祝", "驻", "住", "转拽爪", "爪", "住", "住", "砖拽注", "专住", "", "专转", "", "砖转", "", "驻住", "驻专砖", "专", "", "住", "", "注", "砖", " ", "转 ", "转", "", "住", "住", "", "转", "", "注专", "专", "拽砖砖", "", "", "砖", "砖", "专砖", "驻", "砖", "砖", "砖驻转", "住专", "爪专", "", "", "", "专注", "祝 专", "注专", "", "注爪", "砖专专", "", "住住", "驻专", "专", "砖", "注", "转专", "专", "", "爪驻专", "驻专驻专", "专", "", "注砖", "转砖", "", "住专", "转", "", "拽", "拽住拽住", "专", "住", "驻专", "注转", "转驻", "", "转驻", "注", "", "", "转转", "", "驻专住拽", "砖砖", "砖祝", "", "拽", "注砖", "砖注注转", "驻", "砖转", "砖专", "注祝", "拽爪爪", "住拽", "拽拽", "拽专住", "专拽住", "住", "专拽", "专", "转", "住", "住", "砖拽", "专", "拽砖驻", "", "砖", "祝", "", "住\"", "", "住", "祝", "驻转", "拽专砖 转", "驻转", "专 砖", "住", "", "专 ", "砖专转", "专驻住转", "", "注转", "砖转 砖", "专 ", "爪转", "'住", "住专", "'拽", "注", "砖拽驻 砖砖", "转砖", "砖", "专", "专", "住驻", "专拽", "专注", "拽砖转 注", "注拽", "砖", "专", "", "专", "注专", "砖转", "专住", " ", "转 专拽转", "专 砖专", "专", "驻注", "砖专", "驻注", "爪专", "驻拽", "砖", "拽驻抓", "砖转", "注", "砖", "专", "注转", "转拽", "转砖", "专爪转", "拽拽", "专砖", "转", "转拽", "爪", "", "拽", "专", "拽爪专", "注", "专注", "注爪", "注祝", "专注", "爪", "驻", "驻转注", "专砖", "砖注", "", "专注", "驻", "注专", "驻砖", "专", "", "转", "", "住", "转爪", "转注", "拽", "注", "注", "", "", "转转", "", "专", "拽爪转", "", "转", "驻注", "祝 驻注", " 砖注", " 砖", "转 专", "注  专", " 注", " 专", "砖 ", " 砖"];
let words = [...defaultWords]; let customWords = []; let availableWords = []; const state = { teams: [], currentTeamIndex: 0, timerInterval: null, timeLeft: 60, gameActive: false, turnScore: 0, roundTime: 60, winningScore: 20, inLastRound: false, inTieBreaker: false }; const successSound = new Audio('https://cdn.jsdelivr.net/gh/hutzpa-games/ktze-halashon/docs/success.mp3'); const loseSound = new Audio('https://cdn.jsdelivr.net/gh/hutzpa-games/ktze-halashon/docs/lose.mp3'); const victorySound = new Audio('https://cdn.jsdelivr.net/gh/hutzpa-games/ktze-halashon/docs/victory.mp3'); const tickingSound = new Audio('https://cdn.jsdelivr.net/gh/hutzpa-games/ktze-halashon/docs/ticking.mp3');
const setupScreen = document.getElementById('setup-screen'); const gameScreen = document.getElementById('game-screen'); const turnOverModal = document.getElementById('turn-over-modal'); const winningScreen = document.getElementById('winning-screen'); const winningModalContent = document.getElementById('winning-modal-content'); const howToPlayModal = document.getElementById('how-to-play-modal'); const customWordsModal = document.getElementById('custom-words-modal'); const teamInputsContainer = document.getElementById('team-inputs-container'); const addTeamBtn = document.getElementById('add-team-btn'); const scoreOptions = document.getElementById('score-options'); const startGameBtn = document.getElementById('start-game-btn'); const howToPlayBtn = document.getElementById('how-to-play-btn'); const closeHowToPlayBtn = document.getElementById('close-how-to-play-btn'); const addWordsBtn = document.getElementById('add-words-btn'); const closeCustomWordsBtn = document.getElementById('close-custom-words-btn'); const saveCustomWordsBtn = document.getElementById('save-custom-words-btn'); const customWordsTextarea = document.getElementById('custom-words-textarea'); const scoresContainer = document.getElementById('scores-container'); const timerDisplay = document.getElementById('timer'); const wordDisplay = document.getElementById('word-display'); const wordCard = document.getElementById('word-card'); const actionButtons = document.getElementById('action-buttons'); const currentTeamNameCard = document.getElementById('current-team-name-card'); const correctBtn = document.getElementById('correct-btn'); const skipBtn = document.getElementById('skip-btn'); const finishedTeamName = document.getElementById('finished-team-name'); const turnScoreDisplay = document.getElementById('turn-score'); const nextTurnBtn = document.getElementById('next-turn-btn'); const winningTeamName = document.getElementById('winning-team-name'); const playAgainBtn = document.getElementById('play-again-btn'); const countdownModal = document.getElementById('countdown-modal'); const countdownDisplay = document.getElementById('countdown-display'); const editScoresBtn = document.getElementById('edit-scores-btn'); const editScoresModal = document.getElementById('edit-scores-modal'); const closeEditScoresBtn = document.getElementById('close-edit-scores-btn'); const saveScoresBtn = document.getElementById('save-scores-btn'); const editScoresList = document.getElementById('edit-scores-list');
startGameBtn.addEventListener('click', startGame); wordCard.addEventListener('click', () => flipCardAndStartTurn(false)); correctBtn.addEventListener('click', () => handleCorrect(false)); skipBtn.addEventListener('click', () => handleSkip(false)); nextTurnBtn.addEventListener('click', setupNextTurn); playAgainBtn.addEventListener('click', resetGame); howToPlayBtn.addEventListener('click', () => howToPlayModal.classList.remove('hidden')); closeHowToPlayBtn.addEventListener('click', () => howToPlayModal.classList.add('hidden')); addWordsBtn.addEventListener('click', () => customWordsModal.classList.remove('hidden')); closeCustomWordsBtn.addEventListener('click', () => customWordsModal.classList.add('hidden')); saveCustomWordsBtn.addEventListener('click', saveCustomWords); addTeamBtn.addEventListener('click', addTeamInput); teamInputsContainer.addEventListener('click', (e) => { if (e.target && e.target.classList.contains('remove-team-btn')) { e.target.parentElement.remove(); } }); scoreOptions.addEventListener('click', (e) => { if (e.target.classList.contains('score-option')) { scoreOptions.querySelectorAll('.score-option').forEach(btn => btn.classList.remove('selected')); e.target.classList.add('selected'); } }); editScoresBtn.addEventListener('click', openEditScoresModal); closeEditScoresBtn.addEventListener('click', () => editScoresModal.classList.add('hidden')); saveScoresBtn.addEventListener('click', saveScores); editScoresList.addEventListener('click', handleScoreChangeInModal);

function handleIncomingData(fromId, rawData) {
    const data = JSON.parse(rawData.toString());
    console.log('Received data:', data);

    if (multiplayer.isHost) {
        if (data.type === 'ACTION') {
            if (data.payload === 'correct') handleCorrect(true);
            if (data.payload === 'skip') handleSkip(true);
        }
    } else {
        if (data.type === 'GAME_START') {
            Object.assign(state, data.initialState);
            renderScoreboard();
            updateTurnIndicator();
            timerDisplay.textContent = state.roundTime;
            showScreen('game-screen');
        }
        if (data.type === 'STATE_UPDATE') {
            Object.assign(state, data.newState);
            updateScoreDisplay();
            updateTurnIndicator();
            timerDisplay.textContent = state.timeLeft;
        }
        if (data.type === 'YOUR_TURN') {
            wordDisplay.textContent = data.word;
            flipCardAndStartTurn(true);
        }
         if (data.type === 'TURN_OVER') {
             endTurn(true);
         }
         if (data.type === 'GAME_OVER') {
             endGame(data.winningTeam, true);
         }
         if (data.type === 'SETUP_NEXT_TURN') {
             Object.assign(state, data.newState);
             setupNextTurn(true);
         }
    }
}

function playSound(sound) { sound.currentTime = 0; sound.play().catch(e => console.log("Audio play failed:", e)); }
function addTeamInput() { const teamCount = teamInputsContainer.children.length; const newTeamInput = document.createElement('div'); newTeamInput.className = 'flex items-center gap-2'; newTeamInput.innerHTML = ` <label for="team${teamCount + 1}-name" class="sr-only">砖 拽爪 ${teamCount + 1}</label> <input type="text" id="team${teamCount + 1}-name" placeholder="砖 拽爪 ${teamCount + 1}" class="team-name-input w-full p-3 border-2 border-gray-300 rounded-lg text-center text-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition"> <button class="remove-team-btn text-gray-400 hover:text-red-500 text-2xl font-bold">&times;</button> `; teamInputsContainer.appendChild(newTeamInput); }
function saveCustomWords() { const newWords = customWordsTextarea.value.split('\n').map(word => word.trim()).filter(word => word.length > 0); if (newWords.length > 0) { const newUniqueWords = newWords.filter(w => !customWords.includes(w)); customWords.push(...newUniqueWords); words = [...new Set([...defaultWords, ...customWords])]; const originalText = saveCustomWordsBtn.textContent; saveCustomWordsBtn.textContent = '砖专!'; saveCustomWordsBtn.disabled = true; saveCustomWordsBtn.classList.remove('btn-red'); saveCustomWordsBtn.classList.add('bg-green-500'); setTimeout(() => { customWordsModal.classList.add('hidden'); saveCustomWordsBtn.textContent = originalText; saveCustomWordsBtn.classList.add('btn-red'); saveCustomWordsBtn.classList.remove('bg-green-500'); saveCustomWordsBtn.disabled = false; customWordsTextarea.value = ''; }, 1500); } else { customWordsModal.classList.add('hidden'); } }
function shuffle(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[array[i], array[j]] = [array[j], array[i]]; } }
function getNextWord() { if (availableWords.length === 0) { console.log("Word deck empty. Reshuffling..."); availableWords = [...words]; shuffle(availableWords); } return availableWords.pop(); }

// --- MODIFIED GAME FUNCTIONS ---
function startGame() {
    if (multiplayer.isHost) {
        const selectedScore = scoreOptions.querySelector('.selected').dataset.value;
        state.roundTime = 60;
        state.winningScore = parseInt(selectedScore) || 20;
        state.teams = [];
        state.inLastRound = false; state.inTieBreaker = false;
        document.getElementById('tie-breaker-banner').classList.add('hidden');
        document.getElementById('last-round-banner').classList.add('hidden');
        const teamNameInputs = document.querySelectorAll('.team-name-input');
        teamNameInputs.forEach((input, index) => { state.teams.push({ name: input.value || `拽爪 ${index + 1}`, score: 0, id: index }); });
        availableWords = [...words];
        shuffle(availableWords);
        broadcast({ type: 'GAME_START', initialState: state });
    }
    renderScoreboard();
    timerDisplay.textContent = state.roundTime;
    showScreen('game-screen');
    editScoresBtn.classList.remove('hidden');
    updateTurnIndicator();
}
function renderScoreboard() { scoresContainer.innerHTML = ''; state.teams.forEach(team => { const scoreBox = document.createElement('div'); scoreBox.id = `score-box-${team.id}`; scoreBox.className = 'score-box p-3 rounded-lg text-center shadow-md'; scoreBox.innerHTML = ` <div id="team-name-${team.id}" class="font-bold text-base md:text-lg truncate">${team.name}</div> <div id="team-score-${team.id}" class="text-2xl font-black">${team.score}</div> `; scoresContainer.appendChild(scoreBox); }); }
function updateTurnIndicator() { document.querySelectorAll('.score-box').forEach(box => box.classList.remove('active')); const currentTeam = state.teams[state.currentTeamIndex]; if (!currentTeam) return; currentTeamNameCard.textContent = currentTeam.name; const currentScoreBox = document.getElementById(`score-box-${currentTeam.id}`); if (currentScoreBox) { currentScoreBox.classList.add('active'); } }
function flipCardAndStartTurn(isPeer = false) {
    if (state.gameActive) return;
    if (isPeer) {
        wordCard.classList.add('is-flipped'); actionButtons.classList.remove('hidden'); state.gameActive = true;
        return;
    }
    // Logic for the player whose turn it is (could be host or a peer) to start the turn
    // We assume the host is always the player for now. This would need to be expanded with player-to-team mapping.
    startRoundCountdown();
}
function startRoundCountdown() {
    editScoresBtn.classList.add('hidden'); countdownModal.classList.remove('hidden'); let countdown = 3; countdownDisplay.textContent = countdown;
    const countdownInterval = setInterval(() => {
        countdown--;
        if (countdown > 0) { countdownDisplay.textContent = countdown; } else {
            clearInterval(countdownInterval); countdownModal.classList.add('hidden');
            wordCard.classList.add('is-flipped'); actionButtons.classList.remove('hidden');
            if (multiplayer.isHost) {
                // Here you'd send the word to the active peer. For now, we assume the host is playing.
                const word = getNextWord();
                broadcast({ type: 'YOUR_TURN', word: word });
                wordDisplay.textContent = word;
                startTimer();
            }
        }
    }, 1000);
}
function startTimer() {
    if (!multiplayer.isHost) return;
    state.gameActive = true; state.timeLeft = state.roundTime; timerDisplay.textContent = state.timeLeft;
    timerDisplay.parentElement.classList.remove('animate-pulse', 'bg-red-200');
    tickingSound.pause(); tickingSound.currentTime = 0;
    state.timerInterval = setInterval(() => {
        state.timeLeft--;
        broadcast({ type: 'STATE_UPDATE', newState: { timeLeft: state.timeLeft } });
        timerDisplay.textContent = state.timeLeft;
        if (state.timeLeft === 10) { playSound(tickingSound); }
        if (state.timeLeft <= 10 && !timerDisplay.parentElement.classList.contains('animate-pulse')) { timerDisplay.parentElement.classList.add('animate-pulse', 'bg-red-200'); }
        if (state.timeLeft <= 0) { endTurn(); }
    }, 1000);
}
function handleCorrect(fromPeer = false) {
    if (!state.gameActive) return;
    if (!multiplayer.isHost && !fromPeer) {
        multiplayer.peer.send(JSON.stringify({ type: 'ACTION', payload: 'correct' }));
        return;
    }
    playSound(successSound);
    const currentTeam = state.teams[state.currentTeamIndex]; currentTeam.score++; state.turnScore++;
    showScoreAnimation(currentTeam.id, 1);
    if (!state.inLastRound && currentTeam.score >= state.winningScore) { state.inLastRound = true; }
    if (state.inLastRound) { updateLastRoundBanner(); }
    setTimeout(() => { updateScoreDisplay(); }, 150);
    if (!state.gameActive) return;
    if (multiplayer.isHost) {
        const newWord = getNextWord();
        wordDisplay.textContent = newWord;
        broadcast({ type: 'STATE_UPDATE', newState: { teams: state.teams, turnScore: state.turnScore } });
        broadcast({ type: 'YOUR_TURN', word: newWord }); // Update word for everyone
    }
}
function handleSkip(fromPeer = false) {
    if (!state.gameActive) return;
    if (!multiplayer.isHost && !fromPeer) {
        multiplayer.peer.send(JSON.stringify({ type: 'ACTION', payload: 'skip' }));
        return;
    }
    playSound(loseSound);
    const currentTeam = state.teams[state.currentTeamIndex];
    if (currentTeam.score > 0) { currentTeam.score--; showScoreAnimation(currentTeam.id, -1); }
    if (state.inLastRound) { updateLastRoundBanner(); }
    setTimeout(() => { updateScoreDisplay(); }, 150);
    if (multiplayer.isHost) {
        const newWord = getNextWord();
        wordDisplay.textContent = newWord;
        broadcast({ type: 'STATE_UPDATE', newState: { teams: state.teams } });
        broadcast({ type: 'YOUR_TURN', word: newWord });
    }
}
function updateScoreDisplay() { state.teams.forEach(team => { const teamScoreEl = document.getElementById(`team-score-${team.id}`); if (teamScoreEl) teamScoreEl.textContent = team.score; }); }
function showScoreAnimation(teamId, amount) { const scoreBox = document.getElementById(`score-box-${teamId}`); if (!scoreBox) return; const animationEl = document.createElement('div'); animationEl.classList.add('score-change'); if (amount > 0) { animationEl.textContent = `+${amount}`; animationEl.classList.add('plus-one'); } else { animationEl.textContent = `${amount}`; animationEl.classList.add('minus-one'); } scoreBox.appendChild(animationEl); setTimeout(() => { animationEl.remove(); }, 800); }
function updateLastRoundBanner() { const banner = document.getElementById('last-round-banner'); if (!state.inLastRound) { banner.classList.add('hidden'); return; } const maxScore = Math.max(...state.teams.map(team => team.score)); if (maxScore < state.winningScore) { banner.classList.add('hidden'); state.inLastRound = false; return; } const leadingTeams = state.teams.filter(team => team.score === maxScore); let bannerText = ''; if (leadingTeams.length === 1) { bannerText = `住 专! ${leadingTeams[0].name} 注转 爪!`; } else { bannerText = `住 专! 转拽 爪专转 注 ${maxScore} 拽转!`; } banner.textContent = bannerText; banner.classList.remove('hidden'); }
function endTurn(isPeer = false) {
    state.gameActive = false;
    if (multiplayer.isHost && !isPeer) { clearInterval(state.timerInterval); broadcast({ type: 'TURN_OVER' }); }
    const currentTeam = state.teams[state.currentTeamIndex];
    finishedTeamName.textContent = currentTeam.name; turnScoreDisplay.textContent = state.turnScore;
    turnOverModal.classList.remove('hidden');
}
function setupNextTurn(isPeer = false) {
    if (!multiplayer.isHost && !isPeer) return;
    turnOverModal.classList.add('hidden'); editScoresBtn.classList.remove('hidden'); state.turnScore = 0;
    if (multiplayer.isHost) {
        const isLastTeamOfRound = state.currentTeamIndex === state.teams.length - 1;
        // Winner check logic (simplified)
        const winner = state.teams.find(t => t.score >= state.winningScore);
        if (winner) {
            endGame(winner);
            return;
        }
        state.currentTeamIndex = (state.currentTeamIndex + 1) % state.teams.length;
        broadcast({type: 'SETUP_NEXT_TURN', newState: { turnScore: state.turnScore, currentTeamIndex: state.currentTeamIndex }});
    }
    updateTurnIndicator(); timerDisplay.textContent = state.roundTime;
    timerDisplay.parentElement.classList.remove('animate-pulse', 'bg-red-200');
    actionButtons.classList.add('hidden'); wordCard.classList.remove('is-flipped');
}
function endGame(winningTeam, isPeer = false) {
    if (multiplayer.isHost && !isPeer) { clearInterval(state.timerInterval); broadcast({ type: 'GAME_OVER', winningTeam }); }
    tickingSound.pause(); playSound(victorySound); state.gameActive = false;
    document.getElementById('last-round-banner').classList.add('hidden'); document.getElementById('tie-breaker-banner').classList.add('hidden');
    winningTeamName.textContent = winningTeam.name; turnOverModal.classList.add('hidden');
    editScoresBtn.classList.add('hidden'); winningScreen.classList.remove('hidden');
    setTimeout(() => { winningModalContent.classList.remove('scale-95', 'opacity-0'); }, 50);
}
function resetGame() { window.location.reload(); } // Simplest way to reset for everyone
function openEditScoresModal() { editScoresList.innerHTML = ''; state.teams.forEach(team => { const teamEditRow = document.createElement('div'); teamEditRow.className = 'flex items-center justify-between bg-gray-100 p-3 rounded-lg'; teamEditRow.innerHTML = ` <span class="font-bold text-lg">${team.name}</span> <div class="flex items-center gap-4"> <button data-team-id="${team.id}" data-action="minus" class="w-8 h-8 rounded-full bg-red-200 text-red-700 font-bold text-xl flex items-center justify-center">-</button> <span class="text-2xl font-black w-10 text-center" data-score-for-team="${team.id}">${team.score}</span> <button data-team-id="${team.id}" data-action="plus" class="w-8 h-8 rounded-full bg-green-200 text-green-700 font-bold text-xl flex items-center justify-center">+</button> </div> `; editScoresList.appendChild(teamEditRow); }); editScoresModal.classList.remove('hidden'); }
function handleScoreChangeInModal(e) { const action = e.target.dataset.action; const teamId = e.target.dataset.teamId; if (!action || !teamId) return; const scoreSpan = editScoresList.querySelector(`[data-score-for-team="${teamId}"]`); let currentScore = parseInt(scoreSpan.textContent, 10); if (action === 'plus') { currentScore++; } else if (action === 'minus' && currentScore > 0) { currentScore--; } scoreSpan.textContent = currentScore; }
function saveScores() { const scoreSpans = editScoresList.querySelectorAll('[data-score-for-team]'); scoreSpans.forEach(span => { const teamId = parseInt(span.dataset.scoreForTeam, 10); const newScore = parseInt(span.textContent, 10); const team = state.teams.find(t => t.id === teamId); if (team) { team.score = newScore; } }); updateScoreDisplay(); editScoresModal.classList.add('hidden'); if (multiplayer.isHost) { broadcast({ type: 'STATE_UPDATE', newState: { teams: state.teams } }); } const anyTeamReachedGoal = state.teams.some(t => t.score >= state.winningScore); if (anyTeamReachedGoal) { state.inLastRound = true; updateLastRoundBanner(); } else { state.inLastRound = false; document.getElementById('last-round-banner').classList.add('hidden'); } }

</script>

</body>
</html>